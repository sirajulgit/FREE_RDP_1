name: RDP

on:
  workflow_dispatch:
    inputs:
      rdp_user:
        description: "Enter RDP Username"
        required: true
        type: string
      rdp_pass:
        description: "Enter RDP Password (min 8 characters: Upper, Lower, Number, Special)"
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

      # -----------------------------
      # ENABLE RDP
      # -----------------------------
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Allow" >$null 2>&1
          netsh advfirewall firewall add rule name="RDP-Allow" `
            dir=in action=allow protocol=TCP localport=3389

          Restart-Service TermService -Force

      # -----------------------------
      # CREATE USER WITH VALIDATION
      # -----------------------------
      - name: Create User With Password Validation
        run: |
          $Username = "${{ github.event.inputs.rdp_user }}"
          $Password = "${{ github.event.inputs.rdp_pass }}"

          Write-Host "Validating password..."

          if ($Password.Length -lt 8) {
            Write-Error "Password must be at least 8 characters."
            exit 1
          }
          if ($Password -notmatch "[A-Z]") {
            Write-Error "Password must contain at least one uppercase letter."
            exit 1
          }
          if ($Password -notmatch "[a-z]") {
            Write-Error "Password must contain at least one lowercase letter."
            exit 1
          }
          if ($Password -notmatch "[0-9]") {
            Write-Error "Password must contain at least one number."
            exit 1
          }
          if ($Password -notmatch "[!@#$%^&*()_\-+=\[\]{};':"",.<>/?]") {
            Write-Error "Password must contain at least one special character."
            exit 1
          }

          $SecurePass = ConvertTo-SecureString $Password -AsPlainText -Force

          New-LocalUser -Name $Username -Password $SecurePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username

          echo "RDP_USER=$Username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$Password" >> $env:GITHUB_ENV

      # -----------------------------
      # INSTALL TAILSCALE
      # -----------------------------
      - name: Install Tailscale
        run: |
          $URL = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $Installer = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest $URL -OutFile $Installer
          Start-Process msiexec.exe -ArgumentList "/i `"$Installer`" /quiet /norestart" -Wait
          Remove-Item $Installer -Force

      # -----------------------------
      # CONNECT TAILSCALE
      # -----------------------------
      - name: Connect Tailscale
        run: |
          $AUTH = "${{ secrets.TAILSCALE_AUTH_KEY }}"

          if (-not ($AUTH -match "^tskey-auth-")) {
            Write-Error "❌ INVALID AUTH KEY — Must start with 'tskey-auth-'"
            exit 1
          }

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=$AUTH `
            --hostname=gh-runner-${{ github.run_id }}

          Start-Sleep -Seconds 8

          $tsip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4

          if (-not $tsip) {
            Write-Error "Failed to obtain Tailscale IP."
            exit 1
          }

          echo "TAILSCALE_IP=$tsip" >> $env:GITHUB_ENV

      # -----------------------------
      # SHOW CONNECTION DETAILS
      # -----------------------------
      - name: Show RDP Details
        run: |
          Write-Host "`n========= RDP DETAILS ========="
          Write-Host "IP Address : $env:TAILSCALE_IP"
          Write-Host "Username   : $env:RDP_USER"
          Write-Host "Password   : $env:RDP_PASS"
          Write-Host "================================`n"

      # -----------------------------
      # KEEP SESSION ALIVE
      # -----------------------------
      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "RDP Active $(Get-Date)"
            Start-Sleep -Seconds 300
          }
